ScriptLoader.load("ValidForm","Overlay");var CommentsForm=new Class({Extends:ValidForm,Implements:Energine.request,initialize:function(b){this.parent(b);if(this.componentElement&&this.componentElement.getParent("form")){this.form=this.componentElement.getParent("form").addClass("form");$$("div.comments div.comment_inputblock a.link_comment").addEvent("click",this.show_form_base.bind(this));this.form.getElement("a.btn_comment").addEvent("click",this.validateForm.bind(this));this.form.getElement("a.btn_cancel").addEvent("click",this.show_form_base.bind(this));this.form.getElement("textarea").addEvent("keyup",this.countOut.bind(this));$$("li.comment_item div.comment_inputblock").each(function(a){a.getElements("a.btn_edit").addEvent("click",this.editComment.bind(this));a.getElements("a.btn_delete").addEvent("click",this.deleteComment.bind(this));a.getElements("a.btn_comment").addEvent("click",this.show_form.bind(this))}.bind(this))}},maxSymbol:250,trans:null,validateForm:function(b){if(this.parent(b)){this.showOverlay();this.cancelEvent(b);this.request(this.singlePath+"save-comment/",this.form.toQueryString(),function(d){if(d.mode=="update"){var a=$$("li.comment_item[id="+d.data.comment_id+"_comment]");a.getElement("div.hidden.comment_text").set("html",d.data.comment_name);this.show_form_base(true);this.form.getElement("textarea").set("value","")}else{this.show_result(d)}this.overlay.hide()}.bind(this))}},show_result:function(r){if(r.errors){alert(r.errors)}else{if(r.data){var i=r.data[0];var m=$$("li.comment_item.hidden")[0].clone().removeClass("hidden");m.setAttribute("id",i.comment_id+"_comment");m.getElement("div.comment_text").set("html",i.comment_name);m.getElement("div.comment_userpic").grab(new Element("img",{src:i.u_avatar_img,width:50,height:50}));m.getElement("div.comment_username").set("text",i.u_nick);m.getElement("div.comment_date").set("text",i.comment_created);if(m.getElement("div.comment_inputblock")){if(i.is_tree){m.getElement("div.comment_inputblock .btn_comment").addEvent("click",this.show_form.bind(this))}else{m.getElement("div.comment_inputblock").addClass("hidden")}m.getElements("a.btn_edit").addEvent("click",this.editComment.bind(this));m.getElements("a.btn_delete").addEvent("click",this.deleteComment.bind(this))}if(i.comment_parent_id){var p=i.comment_parent_id+"_comment";var d=$$("div.comments ul li#"+p+"");var o=d.getElement("ul");if(!o[0]){o=new Element("ul");o.addClass("comment_list");var n=new Element("div");n.addClass("comment_thread").grab(o);var q=new Element("i",{"class":"icon20x20 comment_thread_icon"});q.grab(new Element("i"));n.grab(q);d.grab(n)}o.grab(m)}else{$$("div.comments").show().getElement("ul").grab(m)}$$("div.comments span")[0].innerHTML="("+($$("div.comments ul li").length-1)+")";if(m.getPrevious("li")&&!(m.getPrevious("li").hasClass("hidden"))){m.getPrevious("li").removeClass("last_item")}else{m.addClass("first_item")}if(!(m.getNext("li"))){m.addClass("last_item")}this.form.addClass("hidden");$$("ul.comment_list div.comment_inputblock").removeClass("hidden");var l=this.componentElement.getElement("textarea[name=comment_name]");l.value="";l.fireEvent("keyup",{target:l},1);new Fx.Scroll(document.getElement(".e-mainframe")?document.getElement(".e-mainframe"):window).toElement(m)}}},show_form:function(e){this.preShowForm();var f=$(e.target).getParent("li");var h=f.getElement("div.comment_text");this.form.inject(h,"after");this.form.getElement("textarea").focus();f.getChildren("div.comment_inputblock").addClass("hidden");var g=this.form.getElement('input[name="parent_id"]');if(!g){g=new Element("input",{type:"hidden",name:"parent_id"});this.form.grab(g)}g.setProperty("value",parseInt(e.target.getParent("li").id));this.form.getElements("div.comment_controlset a.btn_cancel.hidden.").removeClass("hidden");return false},show_form_base:function(d){this.preShowForm();this.form.getElements("div.comment_controlset a.btn_cancel").addClass("hidden");var c=this.form.getElement('input[name="parent_id"]');if(c){c.dispose()}$$("div.comments").grab(this.form);if(!d){this.form.getElement("textarea").focus()}return false},preShowForm:function(){this.setFormCId(0);this.form.getElement("textarea").set("value","");this.form.removeClass("hidden");$$("li.comment_item div.hidden.comment_inputblock").removeClass("hidden");$$("li.comment_item div.comment_text").removeClass("hidden")},countOut:function(b){if(b.target.value.length>=this.maxSymbol){b.target.value=b.target.value.substr(0,this.maxSymbol)}b.target.form.getElements("span.note").set("text",this.countText(this.maxSymbol-b.target.value.length))},countText:function(f){if(!this.trans){this.trans=[this.form.get("comment_symbol1"),this.form.get("comment_symbol2"),this.form.get("comment_symbol3"),this.form.get("comment_remain")]}var g=this.trans[1];if(f.toString().length>1){var h=f.toString().substring(f.toString().length-2,1)}if(f.toString().length>0){var e=f.toString().substring(f.toString().length-1)}if(h==1||e==0||(h!=1&&e>4)){g=this.trans[2]}if(e==1){g=this.trans[0]}return this.trans[3]+" "+f+" "+g},editComment:function(c){this.show_form(c);var d=c.target.getParent("li");d.getElement("div.comment_text").addClass("hidden");this.form.getElement("textarea").set("value",d.getElement("div.comment_text").get("html"));this.setFormCId(parseInt(d.id));return false},setFormCId:function(c){var d=null;if(!(d=this.form.getElement("input[name=comment_id]"))){d=new Element("input",{type:"hidden",name:"comment_id"});this.form.grab(d)}d.set("value",c)},deleteComment:function(f){if(confirm($(this.form).get("comment_realy_remove"))){this.showOverlay();if(this.isEditState){this.showBaseForm()}var f=new Event(f||window.event);var d=$(f.target).getParent("li");var e=parseInt(f.target.getParent("li").id);this.request(this.singlePath+"delete-comment/",{comment_id:e},function(c){if(c.mode=="delete"){if(d.getSiblings("li").length){if((!d.getNext()||d.getNext().hasClass("hidden"))&&(d.getPrevious()&&!d.getPrevious().hasClass("hidden"))){d.getPrevious().addClass("last_item")}if((!d.getPrevious()||d.getPrevious().hasClass("hidden"))&&(d.getNext()&&!d.getNext().hasClass("hidden"))){d.getNext().addClass("first_item")}d.destroy()}else{d.getParents(".comment_thread")[0].destroy()}var a=$$("div.comments .comments_title span.figure")[0];var b=parseInt((a.get("text")).substr(1));a.set("text","("+(b?b-1:0)+")")}this.overlay.hide()}.bind(this),function(){this.overlay.hide();this.showError(response)}.bind(this))}return false},showOverlay:function(){if(!this.overlay){this.overlay=new Overlay(document.getElement(".comments"))}this.overlay.show()}});