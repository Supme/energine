ScriptLoader.load("ValidForm","Overlay");var CommentsForm=new Class({Extends:ValidForm,Implements:Energine.request,initialize:function(a){this.parent(a);if(this.componentElement&&this.componentElement.getParent("form")){this.form=this.componentElement.getParent("form").addClass("form");$$("div.comments div.comment_inputblock a.link_comment").addEvent("click",this.show_form_base.bind(this));this.form.getElement("a.btn_comment").addEvent("click",this.validateForm.bind(this));this.form.getElement("a.btn_cancel").addEvent("click",this.show_form_base.bind(this));this.form.getElement("textarea").addEvent("keyup",this.countOut.bind(this));$$("li.comment_item div.comment_inputblock").each(function(b){b.getElements("a.btn_edit").addEvent("click",this.editComment.bind(this));b.getElements("a.btn_delete").addEvent("click",this.deleteComment.bind(this));b.getElements("a.btn_comment").addEvent("click",this.show_form.bind(this))}.bind(this))}},maxSymbol:250,trans:null,validateForm:function(a){if(this.parent(a)){this.showOverlay();this.cancelEvent(a);this.request(this.singlePath+"save-comment/",this.form.toQueryString(),function(c){if(c.mode=="update"){var b=$$("li.comment_item[id="+c.data.comment_id+"_comment]");b.getElement("div.hidden.comment_text").set("html",c.data.comment_name);this.show_form_base(true);this.form.getElement("textarea").set("value","")}else{this.show_result(c)}this.overlay.hide()}.bind(this))}},show_result:function(a){if(a.errors){alert(a.errors)}else{if(a.data){var j=a.data[0];var g=$$("li.comment_item.hidden")[0].clone().removeClass("hidden");g.setAttribute("id",j.comment_id+"_comment");g.getElement("div.comment_text").set("html",j.comment_name);g.getElement("div.comment_userpic").grab(new Element("img",{src:j.u_avatar_img,width:50,height:50}));g.getElement("div.comment_username").set("text",j.u_nick);g.getElement("div.comment_date").set("text",j.comment_created);if(g.getElement("div.comment_inputblock")){if(j.is_tree){g.getElement("div.comment_inputblock .btn_comment").addEvent("click",this.show_form.bind(this))}else{g.getElement("div.comment_inputblock").addClass("hidden")}g.getElements("a.btn_edit").addEvent("click",this.editComment.bind(this));g.getElements("a.btn_delete").addEvent("click",this.deleteComment.bind(this))}if(j.comment_parent_id){var c=j.comment_parent_id+"_comment";var k=$$("div.comments ul li#"+c+"");var e=k.getElement("ul");if(!e[0]){e=new Element("ul");e.addClass("comment_list");var f=new Element("div");f.addClass("comment_thread").grab(e);var b=new Element("i",{"class":"icon20x20 comment_thread_icon"});b.grab(new Element("i"));f.grab(b);k.grab(f)}e.grab(g)}else{$$("div.comments").show().getElement("ul").grab(g)}$$("div.comments span")[0].innerHTML="("+($$("div.comments ul li").length-1)+")";if(g.getPrevious("li")&&!(g.getPrevious("li").hasClass("hidden"))){g.getPrevious("li").removeClass("last_item")}else{g.addClass("first_item")}if(!(g.getNext("li"))){g.addClass("last_item")}this.form.addClass("hidden");$$("ul.comment_list div.comment_inputblock").removeClass("hidden");var h=this.componentElement.getElement("textarea[name=comment_name]");h.value="";h.fireEvent("keyup",{target:h},1);new Fx.Scroll(document.getElement(".e-mainframe")?document.getElement(".e-mainframe"):window).toElement(g)}}},show_form:function(b){this.preShowForm();var a=$(b.target).getParent("li");var c=a.getElement("div.comment_text");this.form.inject(c,"after");this.form.getElement("textarea").focus();a.getChildren("div.comment_inputblock").addClass("hidden");var d=this.form.getElement('input[name="parent_id"]');if(!d){d=new Element("input",{type:"hidden",name:"parent_id"});this.form.grab(d)}d.setProperty("value",parseInt(b.target.getParent("li").id));this.form.getElements("div.comment_controlset a.btn_cancel.hidden.").removeClass("hidden");return false},show_form_base:function(a){this.preShowForm();this.form.getElements("div.comment_controlset a.btn_cancel").addClass("hidden");var b=this.form.getElement('input[name="parent_id"]');if(b){b.dispose()}$$("div.comments").grab(this.form);if(!a){this.form.getElement("textarea").focus()}return false},preShowForm:function(){this.setFormCId(0);this.form.getElement("textarea").set("value","");this.form.removeClass("hidden");$$("li.comment_item div.hidden.comment_inputblock").removeClass("hidden");$$("li.comment_item div.comment_text").removeClass("hidden")},countOut:function(a){if(a.target.value.length>=this.maxSymbol){a.target.value=a.target.value.substr(0,this.maxSymbol)}a.target.form.getElements("span.note").set("text",this.countText(this.maxSymbol-a.target.value.length))},countText:function(a){if(!this.trans){this.trans=[this.form.get("comment_symbol1"),this.form.get("comment_symbol2"),this.form.get("comment_symbol3"),this.form.get("comment_remain")]}var d=this.trans[1];if(a.toString().length>1){var c=a.toString().substring(a.toString().length-2,1)}if(a.toString().length>0){var b=a.toString().substring(a.toString().length-1)}if(c==1||b==0||(c!=1&&b>4)){d=this.trans[2]}if(b==1){d=this.trans[0]}return this.trans[3]+" "+a+" "+d},editComment:function(b){this.show_form(b);var a=b.target.getParent("li");a.getElement("div.comment_text").addClass("hidden");this.form.getElement("textarea").set("value",a.getElement("div.comment_text").get("html"));this.setFormCId(parseInt(a.id));return false},setFormCId:function(b){var a=null;if(!(a=this.form.getElement("input[name=comment_id]"))){a=new Element("input",{type:"hidden",name:"comment_id"});this.form.grab(a)}a.set("value",b)},deleteComment:function(c){if(confirm($(this.form).get("comment_realy_remove"))){this.showOverlay();if(this.isEditState){this.showBaseForm()}var c=new Event(c||window.event);var b=$(c.target).getParent("li");var a=parseInt(c.target.getParent("li").id);this.request(this.singlePath+"delete-comment/",{comment_id:a},function(d){if(d.mode=="delete"){if(b.getSiblings("li").length){if((!b.getNext()||b.getNext().hasClass("hidden"))&&(b.getPrevious()&&!b.getPrevious().hasClass("hidden"))){b.getPrevious().addClass("last_item")}if((!b.getPrevious()||b.getPrevious().hasClass("hidden"))&&(b.getNext()&&!b.getNext().hasClass("hidden"))){b.getNext().addClass("first_item")}b.destroy()}else{b.getParents(".comment_thread")[0].destroy()}var f=$$("div.comments .comments_title span.figure")[0];var e=parseInt((f.get("text")).substr(1));f.set("text","("+(e?e-1:0)+")")}this.overlay.hide()}.bind(this),function(){this.overlay.hide();this.showError(response)}.bind(this))}return false},showOverlay:function(){if(!this.overlay){this.overlay=new Overlay(document.getElement(".comments"))}this.overlay.show()}});