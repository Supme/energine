ScriptLoader.load("ModalBox");var RichEditor=new Class({dirty:false,fallback_ie:false,initialize:function(a){this.area=$(a)},validateParent:function(a){var b=$(a.parentElement())||null;while($type(b)=="element"&&b!=this.area){b=b.getParent()}return(b==this.area)},action:function(f,d,c){if(this.fallback_ie){return this.fallback(f)}var b=this._getSelection();if(!Energine.supportContentEdit||b.type=="Control"){return}if(Browser.Engine.gecko){document.execCommand("styleWithCSS",false,false)}var a=b.createRange();if(this.validateParent(a)){if(isset(a.execCommand)){a.execCommand(f,(d||false),c)}else{if(f=="CreateLink"){c=prompt("Enter a URL:","http://");d=false}try{document.execCommand(f,(d||false),c)}catch(g){}}this.dirty=true}},fallback:function(a){switch(a){case"Bold":this.wrapSelectionWith("strong");break;case"Italic":this.wrapSelectionWith("em");break;case"InsertOrderedList":this.wrapSelectionWith("ol");break;case"InsertUnorderedList":this.wrapSelectionWith("ul");break;case"CreateLink":this.wrapSelectionWith("a",'href="'+window.prompt("URL")+'"');break;case"JustifyLeft":this.wrapSelectionWith("p",'style="text-align: left;"');break;case"JustifyCenter":this.wrapSelectionWith("p",'style="text-align: center;"');break;case"JustifyRight":this.wrapSelectionWith("p",'style="text-align: right;"');break;case"JustifyFull":this.wrapSelectionWith("p",'style="text-align: justify;"');break;default:}},replaceSelectionWith:function(a){var b=this.textarea.getSelectedRange();this.textarea.value=this.textarea.value.substr(0,b.start)+a+this.textarea.value.substr(b.end)},wrapSelectionWith:function(b,a){a=(a?" "+a:"");this.textarea.insertAroundCursor({before:"<"+b+a+">",defaultMiddle:"",after:"</"+b+">"})},bold:function(){this.action("Bold")},italic:function(){this.action("Italic")},olist:function(){this.action("InsertOrderedList")},ulist:function(){this.action("InsertUnorderedList")},link:function(){this.action("CreateLink",true)},alignLeft:function(){this.action("JustifyLeft")},alignCenter:function(){this.action("JustifyCenter")},alignRight:function(){this.action("JustifyRight")},alignJustify:function(){this.action("JustifyFull")},imageManager:function(){this.currentRange=false;if(Energine.supportContentEdit&&!this.fallback_ie){this.currentRange=this._getSelection().createRange()}ModalBox.open({url:this.area.getProperty("single_template")+"file-library/image/",onClose:this.insertImage.bind(this)})},fileLibrary:function(){this.currentRange=false;if(Energine.supportContentEdit&&!this.fallback_ie){this.currentRange=this._getSelection().createRange()}ModalBox.open({url:this.area.getProperty("single_template")+"file-library",onClose:this.insertFileLink.bind(this)})},insertImage:function(a){if(!a){return}ModalBox.open({url:this.area.getProperty("single_template")+"imagemanager",onClose:function(e){if(!e){return}if($type(this.currentRange)=="collection"){var c=this.currentRange;if(c(0).tagName=="IMG"){var b=c(0);b.src=e.filename;b.width=e.width;b.height=e.height;b.align=e.align;b.alt=e.alt}this.currentRange.select()}else{if(Browser.Engine.gecko&&!this.fallback_ie){var d='<img src="'+e.filename+'" width="'+e.width+'" height="'+e.height+'" align="'+e.align+'" alt="'+e.alt+'" border="0" style="';["margin-left","margin-right","margin-top","margin-bottom"].each(function(f){if(e[f]!=0){d+=f+":"+e[f]+"px;"}});d+='" />';document.execCommand("inserthtml",false,d);this.dirty=true;return}else{if(this.fallback_ie){this.textarea.insertAtCursor('<img src="'+e.filename+'" width="'+e.width+'" height="'+e.height+'" align="'+e.align+'" alt="'+e.alt+'" border="0" />',true);this.dirty=true;return}}this.currentRange.select();if(this.validateParent(this.currentRange)){var d='<img src="'+e.filename+'" width="'+e.width+'" height="'+e.height+'" align="'+e.align+'" alt="'+e.alt+'" border="0" />';this.currentRange.pasteHTML(d);this.dirty=true}}}.bind(this),extraData:a})},insertFileLink:function(b){if(!b){return}var a=b.upl_path;if(this.fallback_ie){this.textarea.insertAtCursor('<a href="'+a+'">'+b.upl_name+"</a>",true);return}if(this.currentRange.select){this.currentRange.select()}if(this.validateParent(this.currentRange)){if(this.currentRange.pasteHTML){if(this.currentRange.text!=""){this.currentRange.pasteHTML('<a href="'+a+'">'+this.currentRange.text+"</a>")}else{this.currentRange.pasteHTML('<a href="'+a+'">'+a+"</a>")}}else{var c;if(this.currentRange.toString()){c='<a href="'+a+'">'+this.currentRange.toString()+"</a>"}else{c='<a href="'+a+'">'+a+"</a>"}document.execCommand("inserthtml",false,c)}this.dirty=true}},processPaste:function(b){var a=this._getSelection();var c=a.createRange();var d=document.body.createTextRange();this.pasteArea.innerHTML="";d.moveToElementText(this.pasteArea);d.select();document.execCommand("paste",false,null);c.select();c.pasteHTML(this.cleanMarkup(this.area.getProperty("componentPath"),this.pasteArea.innerHTML,true));this.pasteArea.innerHTML=""},processPasteFF:function(a){(function(){this.area.innerHTML=this.cleanMarkup(this.area.getProperty("componentPath"),this.area.innerHTML,true)}).delay(300,this)},cleanMarkup:function(c,b,d){var a;new Request({url:c+"cleanup"+(d?"?aggressive=1":""),method:"post",async:false,onSuccess:function(e){a=e}}).send("data="+encodeURIComponent(b));return a},changeFormat:function(b){var a=b.select.value;if(a=="reset"){document.execCommand("FormatBlock",false,"<P>")}else{document.execCommand("FormatBlock",false,"<"+a+">")}b.select.value=""},_getSelection:function(){var a=(document.selection||window.getSelection());if(!isset(a.type)){a.type="Text"}if(!isset(a.createRange)){a.createRange=function(){var b=this.getRangeAt(0);b.parentElement=function(){var c=this.commonAncestorContainer;if(c.nodeType==3){c=c.parentNode}return c};return b}}return a}});