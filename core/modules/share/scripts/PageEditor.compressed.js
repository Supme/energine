ScriptLoader.load("Toolbar","RichEditor","ModalBox","Overlay");var PageEditor=new Class({editorClassName:"nrgnEditor",editors:[],initialize:function(){Asset.css("pagetoolbar.css");Asset.css("pageeditor.css");$(document.body).getElements("."+this.editorClassName).each(function(a){this.editors.push(new PageEditor.BlockEditor(this,a))},this);document.addEvent("click",this.processClick.bindWithEvent(this));window.addEvent("beforeunload",function(){if(this.activeEditor){this.activeEditor.save()}}.bind(this));this.attachToolbar(this.createToolbar())},createToolbar:function(){var a=new Toolbar("wysiwyg_toolbar");a.dock();a.appendControl(new Toolbar.Button({id:"bold",icon:"images/toolbar/bold.gif",title:Energine.translations.get("BTN_BOLD"),action:"bold"}));a.appendControl(new Toolbar.Button({id:"italic",icon:"images/toolbar/italic.gif",title:Energine.translations.get("BTN_ITALIC"),action:"italic"}));a.appendControl(new Toolbar.Button({id:"olist",icon:"images/toolbar/olist.gif",title:Energine.translations.get("BTN_OL"),action:"olist"}));a.appendControl(new Toolbar.Button({id:"ulist",icon:"images/toolbar/ulist.gif",title:Energine.translations.get("BTN_UL"),action:"ulist"}));a.appendControl(new Toolbar.Button({id:"link",icon:"images/toolbar/link.gif",title:Energine.translations.get("BTN_HREF"),action:"link"}));a.appendControl(new Toolbar.Separator({id:"sep3"}));a.appendControl(new Toolbar.Button({id:"left",icon:"images/toolbar/justifyleft.gif",title:Energine.translations.get("BTN_ALIGN_LEFT"),action:"alignLeft"}));a.appendControl(new Toolbar.Button({id:"center",icon:"images/toolbar/justifycenter.gif",title:Energine.translations.get("BTN_ALIGN_CENTER"),action:"alignCenter"}));a.appendControl(new Toolbar.Button({id:"right",icon:"images/toolbar/justifyright.gif",title:Energine.translations.get("BTN_ALIGN_RIGHT"),action:"alignRight"}));a.appendControl(new Toolbar.Button({id:"justify",icon:"images/toolbar/justifyall.gif",title:Energine.translations.get("BTN_ALIGN_JUSTIFY"),action:"alignJustify"}));a.appendControl(new Toolbar.Select({id:"selectFormat",action:"changeFormat"},{"":"",reset:Energine.translations.get("TXT_RESET"),H1:Energine.translations.get("TXT_H1"),H2:Energine.translations.get("TXT_H2"),H3:Energine.translations.get("TXT_H3"),H4:Energine.translations.get("TXT_H4"),H5:Energine.translations.get("TXT_H5"),H6:Energine.translations.get("TXT_H6"),ADDRESS:Energine.translations.get("TXT_ADDRESS")}));a.appendControl(new Toolbar.Separator({id:"sep4"}));a.appendControl(new Toolbar.Button({id:"source",icon:"images/toolbar/source.gif",title:Energine.translations.get("BTN_VIEWSOURCE"),action:"showSource"}));a.appendControl(new Toolbar.Separator({id:"sep5"}));a.appendControl(new Toolbar.Button({id:"imagemngr",icon:"images/toolbar/image.gif",title:Energine.translations.get("BTN_INSERT_IMAGE"),action:"imageManager"}));a.appendControl(new Toolbar.Button({id:"filemngr",icon:"images/toolbar/filemngr.gif",title:Energine.translations.get("BTN_FILE_LIBRARY"),action:"fileLibrary"}));a.bindTo(this);return a},attachToolbar:function(b){this.toolbar=b;this.toolbar.getElement().injectInside(document.getElement(".e-topframe"));this.toolbar.disableControls();var a=$$("html")[0];if(a.hasClass("e-has-topframe2")){a.removeClass("e-has-topframe2");a.addClass("e-has-topframe3")}else{if(a.hasClass("e-has-topframe1")){a.removeClass("e-has-topframe1");a.addClass("e-has-topframe2")}}},getEditorByElement:function(b){var a=false;this.editors.each(function(c){if(c.area==b){a=c}});return a},processClick:function(c){var b=$(c.target);if(b.get("tag")=="td"){b=b.getElement("div."+this.editorClassName)||b}while($type(b)=="element"&&!b.hasClass(this.editorClassName)){b=b.getParent()}if($type(b)!="element"||!b.hasClass(this.editorClassName)){return}if(this.activeEditor){if(this.activeEditor.area!=b){var a=this.getEditorByElement(b);if(a){this.activeEditor.blur();this.activeEditor=a;this.activeEditor.focus()}}}else{this.activeEditor=this.getEditorByElement(b);if(this.activeEditor){this.activeEditor.focus()}}if(!Energine.supportContentEdit&&this.activeEditor){this.activeEditor.showSource()}},processKeyEvent:function(){if(this.activeEditor){this.activeEditor.dirty=true}}});PageEditor.BlockEditor=new Class({Extends:RichEditor,initialize:function(a,b){this.pageEditor=a;this.parent(b);this.singlePath=this.area.getProperty("single_template");this.ID=this.area.getProperty("eID")?this.area.getProperty("eID"):false;this.num=this.area.getProperty("num")?this.area.getProperty("num"):false;if(Energine.supportContentEdit&&!this.fallback_ie){document.addEvent("keydown",this.pageEditor.processKeyEvent.bind(this.pageEditor));if(!(this.pasteArea=$("pasteArea"))){this.pasteArea=new Element("div",{id:"pasteArea"}).setStyles({visibility:"hidden",width:"0",height:"0","font-size":"0","line-height":"0"}).injectInside(document.body)}if(Browser.Engine.trident){this.area.onpaste=this.processPasteFF.bindWithEvent(this)}else{if(Browser.Engine.gecko||Browser.Engine.presto){this.area.onpaste=this.processPasteFF.bindWithEvent(this)}}}this.overlay=new Overlay()},focus:function(){this.area.addClass("activeEditor");var a=this.pageEditor.toolbar.bindTo(this);if(!Energine.supportContentEdit){return}a.enableControls();this.area.contentEditable=true},blur:function(){this.area.removeClass("activeEditor");this.pageEditor.toolbar.bindTo(this.pageEditor).disableControls();if(!Energine.supportContentEdit){return}if(this.dirty){this.save()}this.area.contentEditable="false"},showSource:function(){this.blur();ModalBox.open({url:this.singlePath+"source",extraData:this.cleanMarkup("dummy",this.area.innerHTML),onClose:function(a){if(a||(a==="")){this.area.set("html",this.cleanMarkup("dummy",a));this.dirty=true}this.focus()}.bind(this)})},save:function(){this.dirty=false;var a="data="+encodeURIComponent(this.area.innerHTML);if(this.ID){a+="&ID="+this.ID}if(this.num){a+="&num="+this.num}this.overlay.show();new Request({url:this.singlePath+"save-text",method:"post",data:a,onSuccess:function(b){this.area.innerHTML=b;this.overlay.hide()}.bind(this)}).send()},saveWithConfirmation:function(){if(this.dirty&&confirm("Хотите сохранить изменённый блок?")){this.save()}},cleanMarkup:function(a,b,c){return this.parent(this.singlePath,b,c)}});