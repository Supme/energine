ScriptLoader.load("View");var Grid=new Class({Extends:View,options:{onSelect:$empty,onSortChange:$empty,onDoubleClick:$empty},initialize:function(b,a){Asset.css("grid.css");this.sort={field:null,order:null};this.setOptions(a);this.parent(b,this.options);this.headOff=this.element.getElement(".gridContainer thead");this.headOff.setStyle("display","none");this.tbody=this.element.getElement(".gridContainer tbody");this.headers=this.element.getElements(".gridHeadContainer table.gridTable th");this.headers.addEvent("click",this.changeSort.bind(this));this.element.getParents(".e-pane")[0].addClass("e-grid-pane");if(document.getElement(".e-singlemode-layout")){window.addEvent("resize",this.fitGridSize.bind(this))}else{if(navigator.userAgent.indexOf("MSIE 6")==-1){window.addEvent("resize",this.fitGridFormSize.bind(this))}}},setMetadata:function(b){var a=0;for(var c in b){if(b[c].key){this.keyFieldName=c}}this.parent(b)},build:function(){var a=this.getSelectedRecordKey();this.headOff.setStyle("visibility","hidden");this.headOff.setStyle("display","table-header-group");if(this.data.length){if(!this.dataKeyExists(a)){a=false}this.data.each(function(c,d){this.addRecord(c,d,a)},this);if(!a){this.selectItem(this.tbody.getFirst())}}else{this.addRecord(null)}var b=new Array();this.headOff.getElements("th").each(function(d,c){b[c]=d.clientWidth});this.element.getElements(".gridHeadContainer col").each(function(d,c){d.setStyle("width",b[c])});this.element.getElements(".gridContainer col").each(function(d,c){d.setStyle("width",b[c])});this.element.getElement(".gridContainer table.gridTable").setStyle("tableLayout","fixed");this.element.getElement(".gridHeadContainer table.gridTable").setStyle("tableLayout","fixed");this.headOff.setStyle("display","none");this.paneContent=this.element.getParent(".e-pane-item");this.filter=this.element.getElement(".filter");this.gridHeadContainer=this.element.getElement(".gridHeadContainer");this.gridContainer=this.element.getElement(".gridContainer");this.fitGridSize();if(!(this.minGridHeight)){this.minGridHeight=this.gridContainer.getStyle("height").toInt()}if(!(document.getElement(".e-singlemode-layout"))){this.pane=this.element.getParents(".e-pane")[0];this.gridBodyContainer=this.element.getElement(".gridBodyContainer");this.fitGridFormSize();new Fx.Scroll(document.getElement(".e-mainframe")?document.getElement(".e-mainframe"):window).toElement(this.pane)}},fitGridSize:function(){var a=this.paneContent.getSize().y-((this.filter)?this.filter.getSize().y:0)-this.gridHeadContainer.getSize().y-14;if(a>0){this.gridContainer.setStyle("height",a)}},fitGridFormSize:function(){var e=window.getSize().y-10;var c=this.pane.getSize().y;var b=((this.gridBodyContainer.getSize().y+2)>this.minGridHeight)?(this.gridBodyContainer.getSize().y+2):this.minGridHeight;var a=this.gridContainer.getSize().y;var d=c-a;if(e>(this.minGridHeight+d)){if((b+d)>e){this.pane.setStyle("height",e)}else{this.pane.setStyle("height",b+d)}}else{this.pane.setStyle("height",this.minGridHeight+d)}this.fitGridSize()},isEmpty:function(){return !this.data.length},getSelectedRecord:function(){if(!this.getSelectedItem()){return false}return this.getSelectedItem().record},getSelectedRecordKey:function(){if(!this.keyFieldName){return false}return this.getSelectedRecord()[this.keyFieldName]},dataKeyExists:function(a){if(!this.data){return false}if(!this.keyFieldName){return false}return this.data.some(function(c,b){return(c[this.keyFieldName]==a)}.bind(this))},clear:function(){this.selectItem(false);while(this.tbody.hasChildNodes()){this.tbody.removeChild(this.tbody.firstChild)}},clearHeaders:function(){this.sort.field=null;this.sort.field=null;this.headers.removeProperty("class")},fitHeaders:function(){this.headersContainer.setStyle("visibility","");var a=this.tbody.getFirst();this.headers.each(function(d,b){var c=-(b==0?27:28);if(b==a.childNodes.length-1){c+=((this.data.length||this.prevDataLength>0)?16:0);this.prevDataLength=this.data.length}d.setStyle("width",a.childNodes[b].getSize().size.x+c+"px")},this);if(!this.data.length){this.tbody.getFirst().dispose()}},addRecord:function(d,g,f){if(!d){var j=new Element("tr").injectInside(this.tbody);return}for(var i in d){if(!this.metadata[i]){alert("Grid: record doesn't conform to metadata.");return false}}var j=new Element("tr").addClass(((g/2)==Math.ceil(g/2))?"odd":"even").setProperty("unselectable","on").injectInside(this.tbody);j.record=d;for(var i in d){if(!this.metadata[i].visible||this.metadata[i].type=="hidden"){continue}var h=new Element("td").injectInside(j);if(this.metadata[i].type=="boolean"){var e=new Element("img").setProperties({src:"images/checkbox_"+(d[i]==true?"on":"off")+".png",width:"13",height:"13"}).injectInside(h);h.setStyles({"text-align":"center","vertical-align":"middle"})}else{if(this.metadata[i].type=="image"){if(d[i]){var c=new Element("img").setProperties({src:d[i],width:50,height:50}).injectInside(h);h.setStyles({"text-align":"center","vertical-align":"middle"})}}else{var b="";if(d[i]){var b=d[i].clean()}if(b!=""){h.set("html",b)}else{h.set("html","&#160;")}}}}j.getFirst().addClass("firstColumn");if(f==d[this.keyFieldName]){this.selectItem(j);new Fx.Scroll($(document.body).getElement(".gridContainer")).toElement(j)}var a=this;j.addEvents({mouseover:function(){if(this!=a.getSelectedItem()){this.addClass("highlighted")}},mouseout:function(){this.removeClass("highlighted")},click:function(){if(this!=a.getSelectedItem()){a.selectItem(this)}},dblclick:function(){this.fireEvent("onDoubleClick")}.bind(this)})},changeSort:function(a){var c=function(i){var h=["","asc","desc"],f,g;if((g=h.indexOf(i))!=-1){if((g+1)<h.length){f=h[g+1]}else{f=h[0]}}else{f=h[0]}return f};var e=$(a.target),d=e.getProperty("name"),b=e.getProperty("class");if(this.metadata[d]&&this.metadata[d].sort==1){this.clearHeaders();this.sort.field=d;this.sort.order=c(b);e.addClass(this.sort.order);this.fireEvent("onSortChange")}}});